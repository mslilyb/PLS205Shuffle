---
title: "HW4"
output: 
 html_notebook:
    toc: true
    toc_float: true
    number_sections: true
editor_options: 
  markdown: 
    wrap: 72
---

Necessary libraries

```{r echo = F}
library(ggplot2)
library(emmeans)
library(lme4)
library(lmerTest)
library(multcomp)
library(PLS205)
```

To study the effect of burial time on germination and dormancy of
*Hordeum murinum ssp. leporinum* (Hare Barley), overwintering seeds were
placed in bags in a field, and then removed and tested at six time
intervals (0, 30, 60, 90, 180, and 360 days after burial). The design
was a completely randomized design, with 5 replicate bags per burial
time. Each bag contained 200 seeds. At the designed time, each bag was
opened, and then the seeds were split evenly between two germination
trays, and the number of germinating seeds was measured in each tray.
Two new trays were used for each of the bags.

```{r echo = FALSE}
# Ensure the data file is in the same directory as this document
germinant_data = read.csv('Germination.csv')
germinant_data$Bag = as.factor(germinant_data$Bag)
germinant_data$Tray = as.factor(germinant_data$Tray)
germinant_data$Days = as.factor(germinant_data$Days)
str(germinant_data)
```

## 1 Create a design table for this experiment

Explain your choice of experimental unit

| Structure | Variable   | Type        | \# levels | Replication | Experimental Unit |
|------------|------------|------------|------------|------------|-------------|
| Treatment | Days       | Categorical | 6         | None        | Bag               |
| Design    | Bag        | Categorical | 30        |             |                   |
|           | Tray       | Categorical | 2         |             |                   |
| Response  | Germinants | Numeric     | 60        |             |                   |

> I figured that the bag is the experimental unit. Each set of 5 bags
> corresponds to a single treatment level, but they are not considered
> 'replicates' or 'subsamples', because they are neither subjected to
> each treatment level or part of a larger population respectively. It
> is analagous to an experiment where there was 5 people of the same age
> at each of some number of levels. The people between ages would not be
> replicates. The trays *are* subsamples of the bags and not the
> experimental unit either; they do not receive the treatments
> independently of each other.

## 2 Use a boxplot to visualize the dose-response curve (ie the number of Germinants observed each Day).

Does there appear to be an effect of age (Date) on number of germinating
seeds?

> **Note** For visualization, refer back to the visualization techniques
> in Lab3 when there were subsamples. You should be able to use the same
> code, just be sure to change all the variable names to match the new
> dataset. Be sure to make the variable `Days` into a factor as in Lab4.

```{r}
library(ggplot2)
ggplot(germinant_data,aes(x=Days,y=Germinants)) + 
  geom_boxplot()
```

> There appears to be some effect of age on the number of germinants; it
> appears as if the number of germinants trends downward as the seeds
> get older.

## 3 Assess whether the linear model assumptions are satisfied by the data.

Treat **Days** as a factor. Use diagnostic plots.

> **Note** Here again, refer to Lab 3 for appropriate diagnostic plots.
> Again, the same code should work as long as you are careful to change
> all variable names

```{r}
germodel <- lmer(Germinants~Days + (1|Bag), data = germinant_data)
germodel
pls205_diagnostics(germodel)
```

> Our normality assumption seems to be fine but our variances are all
> over the place. The trend line doesn't completely go off the rails,
> but the hump in the middle means some of ours are a little higher than
> others. It's still probably fine to go forward, but it's cause for
> concern.

## 4 Test (provide p-values as evidence) if any of the extended germination times changed germination rated relative to zero days

> **Note** Refer to Lab3 for correct usage of `emmeans()` with `lmer()`
> models.

```{r}
meanger = emmeans(germodel, specs = 'Days', lmer.df = 'k')

evsc_mger <- contrast(meanger, method = 'trt.vs.ctrl',ref =1)
pvals = summary(evsc_mger, infer = c(F,T))
pvals
```

> It appears as if for any amount of days over 30, there's a significant
> difference in germination rates with a = 0.05

## 5 Repeat the analysis above, except describing which pairs of "lengths of time" caused significantly different germination rates (use α=0.05).

> Note: In an actual analysis, you would either do the analysis in #4 or
> #5, but not both.

Produce a table with groups of treatment levels that cannot be
significantly distinguished with this α.

```{r}
diff_mger <- contrast(meanger, method = 'pairwise')
summeanger = summary(diff_mger, infer = c(F,T))
completdisp = cld(meanger,alpha=0.05,Letters=letters)
completdisp

```

> There's three groups, a, b, and c. b and c have overlap at 30 days,
> which makes the comparison between them a little muddy, but a is
> significantly different from both b and c.

## 6 Using the analyses in #4 and #5, extract confidence intervals from each analysis for all treatment contrasts.

For estimates reported in both analyses: Are the estimates the same? Are
the lengths of the confidence interval the same? Provide an explanation
for why the confidence intervals from one analyses were longer even
though the data and model were the same for both analyses.

```{r}
CIevsc = summary(evsc_mger, infer = c(T,F))
CIdiff = summary(diff_mger, infer = c(T,F))
CIevsc
CIdiff
```

> It looks like each estimate reported in both had the same values
> across the board, but the confidence intervals for the pairwise
> analysis are bigger. In general, pairwise comparisons (i.e., multiple
> comparisons) tend to have larger confidence intervals; if each
> comparison has an alpha of 0.05, the chance of *at least* one false
> positive is additive across all the treatments. In essence, picking
> top effects/different effects/grouping requires all of our CIs to be
> valid, which lessens our confidence in the effect sizes.

## 7 Use an ANOVA to assess the evidence for any effect of time germination rate

Is there strong evidence for a difference in germination rate by seed
age?

> **Note**. The ANOVA table produced by the `lmer()` function looks a
> bit different from that of the `lm()` function. But all the same
> information is there, and it should be clear how to interpret. `DenDF`
> is the degrees of freedom of the denominator of the F-value. `NumDF`
> is the degrees of freedom of the numerator of the F-value. These are
> used with the `F-value` to calculate the p-value (`Pr(>F)`) using the
> `pf()` function.
>
> You should add the argument `ddf = 'Kenward-Roger'` (or abbreviation
> `ddf='K'` whenever you do `anova()` with a `lmer()` model

```{r}
anova_table = anova(germodel, ddf = 'K')
anova_table
```

> ENTER YOUR RESPONSE HERE

## 8 Create the "full" ANOVA table "by-hand" based on R's ANOVA table above

Note: The `Sum Sq` and `Mean Sq` values will be different from R's table

Hint: Start with the `F-value` from above. You can calculate `MSE` from
the `emmeans` table of Treatment effects in Question 4.

```{r}
# Include R code for calculating the SumSq, MeanSq and p-value here
bagnum = 5
treatments = 6
traycount = 2
bags_tot = bagnum * treatments
dfE = treatments * (bagnum - 1)
dfT = treatments - 1
fval = 37.678
meanger
# if SE = 3.64, that means that SE * n**2 = stdev, squared = variance, and so on...
SE = 3.64
variance = (SE * (bagnum * traycount)**0.5)**2 #all the same, it would seem, since the number of samples is the same across all of them.
SSE = (variance * (bagnum)) * treatments
MSE = SSE / dfE
SSE
MSE
MST = fval * MSE
MST
sumsq = MST * dfT
sumsq
pv = pf(fval,dfT,dfE,lower.tail=F)
pv
```

| Source   | Df  | Sum Sq   | Mean Sq  | F-value | p-value      |
|----------|-----|----------|----------|---------|--------------|
| Days     | 5   | 15600.58 | 3120.115 | 37.678  | 1.332515e-10 |
| Residual | 24  | 1987.44  | 82.81    |         |              |
